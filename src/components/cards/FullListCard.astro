---
const { title, href } = Astro.props;
import DraggableCard from "@/components/global/DraggableCard.astro";
import Media from "@/components/utils/Media.astro";
import { SITE_DESCRIPTION } from "../../consts";
import {
  parseLooseDate,
  cleanLooseDate,
  prepareAndSortContent,
} from "@/scripts/cleanDate.js";
import {
  getPressEntries,
  getEventEntries,
  getTeachingEntries,
  getCommonsEntries,
} from "@/data/contentSources.js";
import { entryHasTokens } from "@/data/teachingUtils.js";
import { markdownToHtml } from "@/utils/markdown.js";

// Background & text color map
const colorMap = {
  "Upcoming Events": { background: "#FFBF00", text: "black" },
  Press: { background: "#FFB6C1", text: "black" },
  Talk: { background: "#000", text: "white" },
  Teaching: { background: "#D69EFF", text: "black" },
  Featured: { background: "#FF876D", text: "black" },
  Workshop: { background: "beige", text: "black" },
  Organizing: { background: "#6F4E37", text: "white" },
  Exhibition: { background: "#A0E7E5", text: "black" },
};

const { background = "black", text = "white" } = colorMap[title] || {};

const pressEntries = await getPressEntries();
const eventEntries = await getEventEntries();
const teachingEntries = prepareAndSortContent(await getTeachingEntries());
const commonsEntries = await getCommonsEntries();

// Content selection
const contentFilters = {
  Press: () => pressEntries,
  Talk: () =>
    eventEntries.filter(({ type }) =>
      type ? ["talk"].includes(String(type).toLowerCase()) : false
    ),
  Exhibition: () =>
    eventEntries.filter(({ type }) =>
      type ? ["exhibition", "show"].includes(String(type).toLowerCase()) : false
    ),
  Featured: () =>
    eventEntries.filter(({ type }) => {
      if (!type) return false;
      const t = String(type).toLowerCase();
      return [
        "award",
        "fellowship",
        "residency",
        "conference",
        "panel",
      ].includes(t);
    }),
  Workshop: () =>
    teachingEntries.filter((item) => entryHasTokens(item, ["workshop", "lab"])),
  Teaching: () =>
    teachingEntries.filter((item) =>
      entryHasTokens(item, ["course", "class", "teaching", "studio"])
    ),
  "Code/Contribution": () =>
    eventEntries.filter(({ type }) =>
      type
        ? ["website", "code", "contribution"].includes(
            String(type).toLowerCase()
          )
        : false
    ),
  "Upcoming Events": () =>
    eventEntries.filter(({ date }) => parseLooseDate(date) > new Date()),
  Organizing: () => {
    // Get organizing entries from commons with type containing "organizing"
    return commonsEntries.filter(({ type = "" }) => 
      String(type).toLowerCase().includes("organizing")
    );
  },
};

let contentArray = contentFilters[title] ? contentFilters[title]() : [];

contentArray = prepareAndSortContent(contentArray);
---

<section
  class={`home-card w-full flex flex-col p-4 text-black h-max `}
  style={`background: ${background}; color: ${text};`}
  open
>
  <h2 class="heading1 mb-4">{title}</h2>
  {
    contentArray?.length > 0 && (
      <ul class="w-full border-t pb-2">
        {contentArray.map((item, index) => (
          <li key={index} class="border-b py-2 pb-4">
            <div class="mb-2 grid w-full grid-cols-5 gap-8">
              {item.title && (
                <h3 class="body1 col-span-3 flex flex-col gap-2 !leading-normal font-semibold text-balance">
                  {item.link?.href ? (
                    <a href={item.link.href} class="linkout" target="_blank">
                      {item.title}
                    </a>
                  ) : (
                    item.title
                  )}
                  {item?.note && <span class="code">{item.note}</span>}
                  {item?.collaboration && (
                    <div class="code text-sm italic" set:html={markdownToHtml(item.collaboration)} />
                  )}
                  {item.type && (
                    <span class="code inline-block w-max rounded-2xl border px-[var(--page-margin)] py-1 font-medium">
                      {item.type}
                    </span>
                  )}
                </h3>
              )}

              <div class="col-span-2 text-left">
                {item.date && <h4 class="body1">{item.date}</h4>}{" "}
                {item?.place && (
                  <span class="code mt-4 inline-block">
                    {item.place.split(",")[0]}
                  </span>
                )}
              </div>
            </div>
          </li>
        ))}
      </ul>
    )
  }
</section>
